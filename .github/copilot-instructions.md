## Copilot Instructions for CurioKeep

- **Shape & entrypoints**: Spring Boot 4 / Java 21 backend with Postgres 16; Vite/React TS SPA is bundled into the jar via Maven profile `frontend` and served by [src/main/java/org/rostislav/curiokeep/config/SpaWebConfig.java](src/main/java/org/rostislav/curiokeep/config/SpaWebConfig.java).
- **Run/build**: `docker compose up db` to start Postgres with expected creds. Backend: `./mvnw spring-boot:run` (reads `DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASS`, defaults in [src/main/resources/application.yml](src/main/resources/application.yml)). Full jar + UI: `./mvnw clean package -Pfrontend` (Node 20.19.0, npm 10.2.4 auto-installed). Frontend dev only: `cd frontend && npm ci && npm run dev`.
- **Data model**: Flyway migrations set users/collections/modules/items ([src/main/resources/db/migration/V1__init.sql](src/main/resources/db/migration/V1__init.sql), [V2__auth_and_users.sql](src/main/resources/db/migration/V2__auth_and_users.sql)). Items keep dynamic fields in JSONB `item.attributes`; `item.state_key` FK to `module_state` enforces valid state keys.
- **Modules (core concept)**: XML contracts compiled to JSON and persisted in `module_definition`; states/fields materialized. Startup loader [src/main/java/org/rostislav/curiokeep/modules/ModuleBootstrap.java](src/main/java/org/rostislav/curiokeep/modules/ModuleBootstrap.java) scans `classpath*:modules/*.xml`.
- **Module ingestion pipeline**: [ModuleLoadTx](src/main/java/org/rostislav/curiokeep/modules/ModuleLoadTx.java) runs per module in its own transaction: XSD validation ([ModuleXsdValidator](src/main/java/org/rostislav/curiokeep/modules/ModuleXsdValidator.java)), XML parse ([ModuleXmlParser](src/main/java/org/rostislav/curiokeep/modules/ModuleXmlParser.java)), compile ([ModuleCompiler](src/main/java/org/rostislav/curiokeep/modules/ModuleCompiler.java)), JSON Schema validation ([ModuleContractValidator](src/main/java/org/rostislav/curiokeep/modules/ModuleContractValidator.java) using [src/main/resources/docs/spec/module-contract-v1.schema.json](src/main/resources/docs/spec/module-contract-v1.schema.json)), semantic checks, then upsert module_definition/state/field rows; checksum skips rewrites if XML unchanged.
- **Module rules to remember**: `OWNED` state required; state/field keys unique; provider mappings must reference declared providers and paths start with `/`; workflows must reference known fields/providers. Any violation aborts startup (errors aggregated).
- **Module authoring references**: see [src/main/resources/docs/modules.md](src/main/resources/docs/modules.md), provider normalization contract [src/main/resources/docs/provider-normalization.md](src/main/resources/docs/provider-normalization.md), example [src/main/resources/modules/books.xml](src/main/resources/modules/books.xml).
- **Query APIs**: [ModuleQueryService](src/main/java/org/rostislav/curiokeep/modules/ModuleQueryService.java) returns summaries/details/raw XML; deserializes `definition_json`.
- **Items/business rules**: [ItemService](src/main/java/org/rostislav/curiokeep/items/ItemService.java) enforces collection access via `CollectionAccessService`, validates required fields against module contract, normalizes state keys to uppercase, defaults state to first defined or `OWNED`, manages identifiers.
- **Collections/access control**: Ownership + roles OWNER/ADMIN/EDITOR/VIEWER enforced in [src/main/java/org/rostislav/curiokeep/collections/CollectionService.java](src/main/java/org/rostislav/curiokeep/collections/CollectionService.java).
- **Providers architecture**: Providers live in [src/main/java/org/rostislav/curiokeep/providers/impl](src/main/java/org/rostislav/curiokeep/providers/impl); each implements `MetadataProvider` and returns `ProviderResult` with normalized JSON string under `normalizedFields.json` plus `ProviderAsset` list. Keys must match module mappings. Examples: books (Google/OpenLibrary), media (TMDB/TVMaze/AniList), music (MusicBrainz/Discogs/CoverArtArchive), games (IGDB/RAWG), trading cards (Scryfall), Pok√©API, LEGO (Brickset/Rebrickable), Open Product Data, Internet Archive.
- **Provider config**: API credentials via `curiokeep.providers.*` in application.yml/env (e.g., igdb clientId/token, rawg apiKey, brickset apiKey, rebrickable apiKey). Tests mock HTTP and succeed without creds; runtime skips provider when keys missing.
- **Testing**: `./mvnw test` uses H2 in-memory with stubbed ModuleService for context loads. Provider tests rely on `MockRestServiceServer`; no live API calls. If adding new providers, follow existing tests under [src/test/java/org/rostislav/curiokeep/providers](src/test/java/org/rostislav/curiokeep/providers).
- **Logging & config**: Verbose logger for `org.rostislav.curiokeep` by default. Module resource glob/XSD path configurable via `curiokeep.modules.*`.
- **Frontend**: Minimal shell (health ping). React 19 + MUI + Dexie; configs in `frontend/tsconfig*.json`, [frontend/vite.config.ts](frontend/vite.config.ts).
- **Common pitfalls**: Module load failures block startup; validate XML against XSD/JSON schema before shipping. Database must be reachable (no fallback H2 at runtime). When adding module fields, ensure ItemService required-field validation and FK on `item.state_key` are satisfied. Provider keys must align with module mappings.
