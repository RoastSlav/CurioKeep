# Copilot Instructions for CurioKeep

- **App shape**: Spring Boot 4/Java 21 backend + Postgres 16 + Vite/React (TS) SPA built into the jar via the `frontend` Maven profile; SPA routes are forwarded by [src/main/java/org/rostislav/curiokeep/config/SpaWebConfig.java](src/main/java/org/rostislav/curiokeep/config/SpaWebConfig.java).
- **Run locally**: `docker compose up db` to get Postgres with expected creds; backend via `./mvnw spring-boot:run` (reads `DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASS`, see [src/main/resources/application.yml](src/main/resources/application.yml)); full jar with UI via `./mvnw clean package -Pfrontend` (Node v20.19.0, npm 10.2.4 are auto-installed). Frontend-only dev in `frontend/` with `npm ci` then `npm run dev`.
- **DB + schema**: Flyway migrations define core tables for users, collections, modules, and items ([src/main/resources/db/migration/V1__init.sql](src/main/resources/db/migration/V1__init.sql), [V2__auth_and_users.sql](src/main/resources/db/migration/V2__auth_and_users.sql)). Items store dynamic fields in `item.attributes` JSONB; valid states enforced via FK to `module_state`.
- **Module system (key concept)**: Modules are XML contracts (data only) compiled to JSON and persisted in `module_definition` with states/fields materialized. Startup runner [ModuleBootstrap](src/main/java/org/rostislav/curiokeep/modules/ModuleBootstrap.java) loads built-ins from `classpath*:modules/*.xml`.
- **Module ingestion pipeline**: [ModuleLoadTx](src/main/java/org/rostislav/curiokeep/modules/ModuleLoadTx.java) runs in a new transaction per module: XSD validation ([ModuleXsdValidator](src/main/java/org/rostislav/curiokeep/modules/ModuleXsdValidator.java)), parse ([ModuleXmlParser](src/main/java/org/rostislav/curiokeep/modules/ModuleXmlParser.java)), compile to contract ([ModuleCompiler](src/main/java/org/rostislav/curiokeep/modules/ModuleCompiler.java)), JSON Schema validation ([ModuleContractValidator](src/main/java/org/rostislav/curiokeep/modules/ModuleContractValidator.java) using docs/spec/module-contract-v1.schema.json), semantic rules, then upsert module_definition/state/field rows. Checksums skip rewrites when XML unchanged.
- **Module rules**: `OWNED` state mandatory; state/field keys must be unique; provider mappings must reference declared providers and paths must start with `/`; workflows must point to known fields/providers. Failures are aggregated and will abort startup.
- **Module authoring references**: Philosophy and lifecycle in [src/main/resources/docs/modules.md](src/main/resources/docs/modules.md); normalized provider contract in [src/main/resources/docs/provider-normalization.md](src/main/resources/docs/provider-normalization.md); example module [src/main/resources/modules/books.xml](src/main/resources/modules/books.xml).
- **Module query/read APIs**: [ModuleQueryService](src/main/java/org/rostislav/curiokeep/modules/ModuleQueryService.java) exposes summaries, details, and raw XML by key; contracts are deserialized from `definition_json`.
- **Items/business rules**: [ItemService](src/main/java/org/rostislav/curiokeep/items/ItemService.java) enforces collection access (via `CollectionAccessService`), validates states against module contract, enforces required fields on `attributes` JSON, and manages identifiers. State normalization uppercases keys; missing state defaults to first defined or `OWNED`.
- **Collections and access**: Collections belong to a user; membership roles OWNER/ADMIN/EDITOR/VIEWER gate operations ([src/main/java/org/rostislav/curiokeep/collections/CollectionService.java](src/main/java/org/rostislav/curiokeep/collections/CollectionService.java)).
- **Providers/metadata**: Provider adapters output normalized payloads that module mappings reference. Example [src/main/java/org/rostislav/curiokeep/providers/GoogleBooksProvider.java](src/main/java/org/rostislav/curiokeep/providers/GoogleBooksProvider.java) fetches by ISBN, normalizes to `title/subtitle/authors/publisher/published_year/language/isbn10/isbn13/assets`. Provider keys referenced in modules must match adapter `key()` values.
- **Configuration knobs**: Module resource glob and XSD path come from `curiokeep.modules.*` properties (see [src/main/resources/application.yml](src/main/resources/application.yml)); logging defaults verbose for `org.rostislav.curiokeep`.
- **Testing/debug**: Use `./mvnw test` (Spring Boot defaults). Health check at `/api/health` (frontend [frontend/src/App.tsx](frontend/src/App.tsx) calls it). Actuator is on the classpath; OpenAPI via springdoc (UI at `/swagger-ui`).
- **Database helpers**: `pgcrypto` extension is expected for UUID generation; JSONB helpers live in [src/main/java/org/rostislav/curiokeep/modules/ModuleUtil.java](src/main/java/org/rostislav/curiokeep/modules/ModuleUtil.java).
- **Frontend notes**: Minimal shell right now (health ping). React 19 + MUI + Dexie are installed; TypeScript project config in `frontend/tsconfig*.json`, Vite config in [frontend/vite.config.ts](frontend/vite.config.ts).
- **Common pitfalls**: Module load failures stop startupâ€”validate XML against the XSD and JSON schema before shipping. Missing DB or mismatched creds cause boot failure (no in-memory DB). When adding module fields, remember required-field validation in ItemService and FK constraint on `item.state_key`.

Please suggest edits if any of these points are unclear or if more workflow details are needed.
